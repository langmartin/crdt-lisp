(in-package :crdt-lisp/anti-entropy)

(defun make-store ()
  (fset:empty-map))

(defun put (store key hlc value)
  (let ((prev (fetch-pair store key)))
    (if (or (not prev)
            (h:lt? (car prev) hlc))
        (fset:map ($ store) (key (cons hlc value)))
        store)))

(defun fetch-pair (store key)
  (fset:lookup store key))

(defun fetch (store key)
  (let ((pair (fetch-pair store key)))
    (if (not pair)
        nil
        (cdr pair))))

;;; ========================================================================
;;; Hash key-hulc pairs and xor them together

(defun key-octets (key)
  (-> (cond ((stringp key) key)
            ((listp key) (format nil "窿脲┅ㄢ徕屐后趄轭绛麸镢翦趔┅ㄤ彐躅桴煦镢翦趔ㄨ蹯悱篝蜷铉鹾躅舛桴煦篝蜷铉┅ㄤ彐躅栳箬镱脲桴煦ō揪ㄣ镱汜翦钺翦Ж鲥泗矧躅箝珙邃怡翦俯脲镢翦趔脲ㄨ蹯悱镢翦趔桴煦┅ㄩ蝻钽灬浜溟珏篝箦聃孱沐后栳驳订镢翦趔鹃铘┅ㄤ彐躅镢翦趔鹃铘镢翦趔ㄣ飙轭翕翦蠛镢翦趔鹃铘镢翦趔戾铉翳镢翦趔┅ㄤ彐躅栳箬矧é蝈篝栳箬弩蝈漉沐＇祜瑛矧栳箬弩┅ㄤ彐躅栳箬瞽怡翦ㄨ狍瑭ō栳箬轭翦珏颦戾铉翳ǒ俯沐殪轭绌ㄤ彐躅栳箬篝蜷铉ㄨ狍瑭鏖翳秕麴豸麸篝蜷铉秕舂ō栳箬ㄣ飙轭翕翦蠛轭舡撅泗弭ㄨ狍璀瞽怡翦栳箬┅蟓忉箦洞哄钽镤瀛忉箦洞怡翦秕舂┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇换拈鲩溴躔翳祜汜篝矧犷蝈痱弩孱翳疳珏狍栳箬怩汶弭ㄤ彐躅桁悱怩汶弭篝狎糸铉眢怩汶弭眢怩汶弭泔躅舂ㄩ怩汶弭泔躅暴扉篝ㄨ煦怩汶弭篝癌戾è孱ō篝狎糸铉眢盹篝狎糸铉眢怩汶弭眢┅┅ㄣ镱ㄨ煦怩汶弭篝孱洎ㄨ煦怩汶弭孱í怩汶弭眢博ō怩汶弭泔躅暴┅┅ㄤ彐躅桁悱怩汶弭篝糸礤ㄨ鸿蹯悱篝蜷铉ㄨ喉犭瀛桁呼轫糸礤呼殂癌詈屦镢璀铒溴殇┅ㄨ煦怩汶弭博ㄤ彐躅怩汶弭箫螋篝矧濠ō篝矧ㄦ箦艉篝徕戾箫螋灬礅溽ㄡ猢篝蜷铉戾篌ㄣ後岍ㄣ後猢┅ㄢ蹉脲舡珧秕ㄨ煦怩汶弭ㄨ汉溴驷蹯舡簌篝屙沆镢铋飑栋鞍供┅换翎脲麒殪祠换徵衢ㄢ蹉脲舡箫螋磲脲篝矧濠ㄤ彐躅怩汶弭珧秕鸢箫螋邃轸屙怩汶弭螬戾è箴扉箴扉舡箦聃孱沐后痨轸箦聃孱沐殒灬礅溽ㄩ翦愆篝蜷铉戾篌ㄣ後轸屙ㄣ狎怩汶弭螬箫螋邃轸屙恒秕铘博┅ㄩㄦ箦艉屙痿ㄣ徜箴扉舂Жㄣ镱ㄣ镱ㄣ狎怩汶弭螬ㄣ狎箴扉舂ㄢ蹉脲舡珧秕ㄣ徜箴扉舂ㄣ潋怩汶弭螬┅┅ㄤ彐躅怩汶弭珧秕箫螋邃轸屙怩汶弭螬ㄩ铛祆怩汶弭螬Ж戾舄è箴扉箴扉舡麒殪灬礅溽ㄩ翦愆篝蜷铉戾篌ㄣ後轸屙ㄣ狎怩汶弭螬┅箫螋邃轸屙螬秕蝮ㄣ狎箴扉舂翎殪ㄣ徜箴扉舂┅ㄣ镱ㄣ镱ㄣ狎怩汶弭螬秕蝮ㄢ蹉脲舡珧秕翎殪ㄣ潋怩汶弭螬┅┅ㄤ彐躅箴扉舡麒殪痱邃祗舂箴扉舡麒殪濯痱邃铋祗舂ㄤ彐躅箴扉舡麒殪濯痱邃弩祗舂ㄩ矧铛祆祗舂铒ㄦ躅汜祆痱邃ㄣ狎祗舂┅扉篝铗弼弪箦弩祗舂箴扉舡麒殪濯痱邃ㄣ镱ㄣ狎祗舂弩ㄣ潋祗舂┅箴扉舡麒殪＇弼孱Ж珐箴扉舡麒殪＇弼孱Ж订箴扉舡麒殪＇弼孱Ж订换耢厚蹰汶祜徜Ⅲ痨轸箦聃孱沐ㄤ彐躅栳箬疳螋轸轱铙疳螋螬ㄤ彐躅蝈聃弩篝矧疳螋轸轱瞽骖┅ㄤ彐躅箫螋怡桁篝矧濠